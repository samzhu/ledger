<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(content=~{::content})}">
<body>
<div th:fragment="content">
    <div id="models-app" v-cloak>
        <!-- Header with Day Filters -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>{{ startDate }} ~ {{ endDate }}</span>
            </div>
            <div class="flex flex-wrap gap-2">
                <button v-for="d in [7, 14, 30]" :key="d"
                    @click="changeDays(d)"
                    :class="days === d ? 'bg-gradient-to-r from-indigo-500 to-violet-600 text-white shadow-lg shadow-indigo-500/25' : 'glass-card text-slate-700 dark:text-slate-300 hover:bg-white/80 dark:hover:bg-slate-800/80'"
                    class="px-3 sm:px-4 py-2 rounded-lg text-sm font-medium transition-all">
                    {{ d }} Days
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6">
            <!-- Total Models -->
            <div class="glass-card stat-card rounded-2xl p-4 sm:p-5 group">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm font-medium">Active Models</p>
                    <div class="w-9 h-9 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-500/25 group-hover:scale-110 transition-transform">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">{{ summary.totalModels }}</p>
            </div>

            <!-- Total Requests -->
            <div class="glass-card stat-card rounded-2xl p-4 sm:p-5 group">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm font-medium">Total Requests</p>
                    <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/25 group-hover:scale-110 transition-transform">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">{{ formatNumber(summary.totalRequests) }}</p>
            </div>

            <!-- Total Tokens -->
            <div class="glass-card stat-card rounded-2xl p-4 sm:p-5 group">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm font-medium">Total Tokens</p>
                    <div class="w-9 h-9 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/25 group-hover:scale-110 transition-transform">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">{{ formatNumber(summary.totalTokens) }}</p>
            </div>

            <!-- Total Cost -->
            <div class="glass-card stat-card rounded-2xl p-4 sm:p-5 group">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm font-medium">Total Cost</p>
                    <div class="w-9 h-9 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/25 group-hover:scale-110 transition-transform">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-xl sm:text-2xl font-bold text-emerald-600 dark:text-emerald-400">${{ formatDecimal(summary.totalCost) }}</p>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="glass-card rounded-2xl p-8 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-slate-500 dark:text-slate-400">Loading models...</p>
        </div>

        <template v-else>
            <!-- Model Distribution Charts -->
            <div v-if="models.length > 0" class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6">
                <div class="glass-card rounded-2xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800 dark:text-white mb-4">Token Distribution by Model</h3>
                    <div class="relative aspect-square max-h-[250px] mx-auto">
                        <canvas id="tokenDistChart"></canvas>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800 dark:text-white mb-4">Cost Distribution by Model</h3>
                    <div class="relative aspect-square max-h-[250px] mx-auto">
                        <canvas id="costDistChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Models Table -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-4 sm:px-6 py-4 border-b border-slate-200/50 dark:border-slate-700/50 bg-gradient-to-r from-slate-50/50 dark:from-slate-800/50 to-transparent">
                    <h2 class="text-base sm:text-lg font-semibold text-slate-800 dark:text-white">All Models</h2>
                </div>

                <!-- Mobile Card View -->
                <div class="lg:hidden divide-y divide-slate-100 dark:divide-slate-700/50">
                    <div v-for="(model, index) in models" :key="model.model" class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="w-7 h-7 flex-shrink-0 flex items-center justify-center rounded-full text-xs font-bold"
                                      :class="getRankClass(index)">{{ index + 1 }}</span>
                                <a :href="'/dashboard/models/' + encodeURIComponent(model.model) + '?days=' + days"
                                   class="text-indigo-600 dark:text-indigo-400 font-medium text-sm truncate">
                                    {{ model.model }}
                                </a>
                            </div>
                            <span :class="getSuccessRateClass(model.successRate)">
                                {{ formatDecimal(model.successRate, 1) }}%
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Requests:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300 ml-1">{{ formatNumber(model.totalRequestCount) }}</span>
                            </div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Tokens:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300 ml-1">{{ formatNumber(model.totalTokens) }}</span>
                            </div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Latency:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300 ml-1">{{ formatNumber(model.avgLatencyMs) }}ms</span>
                            </div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Cost:</span>
                                <span class="font-semibold text-emerald-600 dark:text-emerald-400 ml-1">${{ formatDecimal(model.totalEstimatedCostUsd) }}</span>
                            </div>
                        </div>
                    </div>
                    <div v-if="models.length === 0" class="p-8 text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">No model data available</p>
                        <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">Model usage will appear here once API calls are made</p>
                    </div>
                </div>

                <!-- Desktop Table View -->
                <div class="hidden lg:block overflow-x-auto">
                    <table class="w-full min-w-[900px]">
                        <thead class="bg-slate-50/50 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Model</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Requests</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Success Rate</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Input Tokens</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Output Tokens</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total Tokens</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Avg Latency</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Users</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Cost</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                            <tr v-for="(model, index) in models" :key="model.model" class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <span class="w-7 h-7 flex items-center justify-center rounded-full text-xs font-bold"
                                              :class="getRankClass(index)">{{ index + 1 }}</span>
                                        <a :href="'/dashboard/models/' + encodeURIComponent(model.model) + '?days=' + days"
                                           class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">
                                            {{ model.model }}
                                        </a>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">{{ formatNumber(model.totalRequestCount) }}</td>
                                <td class="px-6 py-4 text-right text-sm">
                                    <span :class="getSuccessRateClass(model.successRate)">{{ formatDecimal(model.successRate, 1) }}%</span>
                                </td>
                                <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">{{ formatNumber(model.totalInputTokens) }}</td>
                                <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">{{ formatNumber(model.totalOutputTokens) }}</td>
                                <td class="px-6 py-4 text-right text-sm font-medium text-slate-700 dark:text-slate-200">{{ formatNumber(model.totalTokens) }}</td>
                                <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">{{ formatNumber(model.avgLatencyMs) }}ms</td>
                                <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">{{ model.uniqueUsers }}</td>
                                <td class="px-6 py-4 text-right text-sm text-emerald-600 dark:text-emerald-400 font-semibold">${{ formatDecimal(model.totalEstimatedCostUsd) }}</td>
                            </tr>
                            <tr v-if="models.length === 0">
                                <td colspan="9" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-2xl flex items-center justify-center mb-4">
                                            <svg class="w-8 h-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                            </svg>
                                        </div>
                                        <p class="text-slate-500 dark:text-slate-400 text-sm">No model data available</p>
                                        <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">Model usage will appear here once API calls are made</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>
    </div>

    <style>
        [v-cloak] { display: none; }
    </style>

    <script>
        const { createApp, ref, reactive, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const models = ref([]);
                const days = ref(7);
                const startDate = ref('');
                const endDate = ref('');
                let tokenChartInstance = null;
                let costChartInstance = null;

                const summary = reactive({
                    totalModels: 0,
                    totalRequests: 0,
                    totalTokens: 0,
                    totalCost: 0
                });

                const modelColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

                const formatNumber = (num) => {
                    if (num == null) return '0';
                    return Math.round(num).toLocaleString();
                };

                const formatDecimal = (num, decimals = 2) => {
                    if (num == null) return '0.00';
                    return Number(num).toFixed(decimals);
                };

                const getRankClass = (index) => {
                    if (index === 0) return 'bg-gradient-to-br from-amber-400 to-yellow-500 text-white';
                    if (index === 1) return 'bg-gradient-to-br from-slate-300 to-slate-400 text-white';
                    if (index === 2) return 'bg-gradient-to-br from-orange-400 to-amber-500 text-white';
                    return 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400';
                };

                const getSuccessRateClass = (rate) => {
                    if (rate >= 95) return 'text-emerald-600 dark:text-emerald-400 font-medium';
                    if (rate >= 90) return 'text-amber-600 dark:text-amber-400 font-medium';
                    return 'text-red-600 dark:text-red-400 font-medium';
                };

                const updateSummary = (modelList) => {
                    summary.totalModels = modelList.length;
                    summary.totalRequests = modelList.reduce((sum, m) => sum + (m.totalRequestCount || 0), 0);
                    summary.totalTokens = modelList.reduce((sum, m) => sum + (m.totalTokens || 0), 0);
                    summary.totalCost = modelList.reduce((sum, m) => sum + (Number(m.totalEstimatedCostUsd) || 0), 0);
                };

                const renderCharts = () => {
                    if (models.value.length === 0) return;

                    const isDark = document.documentElement.classList.contains('dark');
                    const textColor = isDark ? '#94a3b8' : '#64748b';

                    // Token Distribution Chart
                    const tokenCanvas = document.getElementById('tokenDistChart');
                    if (tokenCanvas) {
                        if (tokenChartInstance) tokenChartInstance.destroy();
                        tokenChartInstance = new Chart(tokenCanvas, {
                            type: 'doughnut',
                            data: {
                                labels: models.value.map(m => m.model),
                                datasets: [{
                                    data: models.value.map(m => m.totalTokens),
                                    backgroundColor: modelColors.slice(0, models.value.length),
                                    borderWidth: 0,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                cutout: '60%',
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: textColor, boxWidth: 12, padding: 8, font: { size: 11 } }
                                    }
                                }
                            }
                        });
                    }

                    // Cost Distribution Chart
                    const costCanvas = document.getElementById('costDistChart');
                    if (costCanvas) {
                        if (costChartInstance) costChartInstance.destroy();
                        costChartInstance = new Chart(costCanvas, {
                            type: 'doughnut',
                            data: {
                                labels: models.value.map(m => m.model),
                                datasets: [{
                                    data: models.value.map(m => Number(m.totalEstimatedCostUsd) || 0),
                                    backgroundColor: modelColors.slice(0, models.value.length),
                                    borderWidth: 0,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                cutout: '60%',
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: textColor, boxWidth: 12, padding: 8, font: { size: 11 } }
                                    }
                                }
                            }
                        });
                    }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch(`/api/v1/dashboard/models?days=${days.value}`);
                        if (!response.ok) throw new Error('Failed to fetch models');
                        const data = await response.json();
                        models.value = data.models || [];
                        startDate.value = data.startDate || '';
                        endDate.value = data.endDate || '';
                        updateSummary(models.value);
                        await nextTick();
                        renderCharts();
                    } catch (error) {
                        console.error('Error fetching models:', error);
                        models.value = [];
                        updateSummary([]);
                    } finally {
                        loading.value = false;
                    }
                };

                const changeDays = (d) => {
                    days.value = d;
                    fetchData();
                };

                onMounted(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlDays = parseInt(urlParams.get('days'));
                    if (urlDays && [7, 14, 30].includes(urlDays)) {
                        days.value = urlDays;
                    }
                    fetchData();
                });

                return {
                    loading,
                    models,
                    days,
                    startDate,
                    endDate,
                    summary,
                    formatNumber,
                    formatDecimal,
                    getRankClass,
                    getSuccessRateClass,
                    changeDays
                };
            }
        }).mount('#models-app');
    </script>
</div>
</body>
</html>
