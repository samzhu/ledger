<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:fragment="html(content)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Ledger - LLM Usage Analytics'">Ledger</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe',
                            300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1',
                            600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.min.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
    </script>

    <!-- Theme initialization (before body to prevent flash) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('ledger-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <style>
        /* === CSS Custom Properties === */
        :root {
            --sidebar-width: 256px;
            --sidebar-collapsed-width: 72px;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .dark {
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }

        /* === Gradient Mesh Background === */
        .bg-mesh {
            background-image:
                radial-gradient(at 40% 20%, rgba(99, 102, 241, 0.12) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.08) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(79, 70, 229, 0.06) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(167, 139, 250, 0.08) 0px, transparent 50%);
        }

        .dark .bg-mesh {
            background-image:
                radial-gradient(at 40% 20%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.12) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(79, 70, 229, 0.08) 0px, transparent 50%);
        }

        /* === Glassmorphism === */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* === Stat Card Hover === */
        .stat-card {
            transition: transform 200ms ease, box-shadow 200ms ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .dark .stat-card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
        }

        /* === Sidebar Transitions === */
        .sidebar-transition {
            transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-transition {
            transition: margin-left 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-label-transition {
            transition: opacity 150ms ease-in-out, width 150ms ease-in-out;
        }

        /* Collapsed sidebar nav labels */
        .sidebar-collapsed .nav-label {
            opacity: 0;
            width: 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .sidebar-expanded .nav-label {
            opacity: 1;
            width: auto;
        }

        /* Toggle icon rotation */
        .toggle-icon-transition {
            transition: transform 300ms ease-in-out;
        }

        .sidebar-collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        /* === Mobile Drawer === */
        .mobile-drawer-transition {
            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .overlay-transition {
            transition: opacity 300ms ease;
        }

        /* === Scrollbar === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* === Progress Ring === */
        .progress-ring { transition: stroke-dashoffset 0.5s ease-in-out; }

        /* === Tooltip for collapsed sidebar === */
        .sidebar-collapsed .nav-item:hover .nav-tooltip {
            display: block;
        }
        .nav-tooltip {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen antialiased bg-slate-100 dark:bg-slate-900 bg-mesh">

    <!-- ==================== Mobile Overlay ==================== -->
    <div id="mobile-overlay"
         class="overlay-transition fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden opacity-0 pointer-events-none"
         onclick="closeMobileSidebar()"></div>

    <!-- ==================== Mobile Sidebar Drawer ==================== -->
    <aside id="mobile-sidebar"
           class="mobile-drawer-transition fixed inset-y-0 left-0 w-72 z-50 lg:hidden
                  bg-slate-900 dark:bg-slate-950 shadow-2xl flex flex-col
                  -translate-x-full">

        <!-- Mobile Header -->
        <div class="flex items-center justify-between h-16 px-4 border-b border-slate-800/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-violet-600
                            rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/25">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight">Ledger</h1>
                    <p class="text-xs text-slate-400">LLM Analytics</p>
                </div>
            </div>
            <button onclick="closeMobileSidebar()"
                    class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Mobile Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 px-3">
            <div class="mb-2 px-3">
                <span class="text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Dashboard</span>
            </div>

            <a th:href="@{/dashboard}"
               th:classappend="${currentPage == 'overview'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span class="font-medium">Overview</span>
            </a>

            <a th:href="@{/dashboard/users}"
               th:classappend="${currentPage == 'users'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="font-medium">Users</span>
            </a>

            <a th:href="@{/dashboard/models}"
               th:classappend="${currentPage == 'models'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="font-medium">Models</span>
            </a>

            <a th:href="@{/dashboard/errors}"
               th:classappend="${currentPage == 'errors'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span class="font-medium">Errors</span>
            </a>

            <div class="mt-6 mb-2 px-3">
                <span class="text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Management</span>
            </div>

            <a th:href="@{/dashboard/quota}"
               th:classappend="${currentPage == 'quota'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <span class="font-medium">Quota</span>
            </a>
        </nav>

        <!-- Mobile Footer -->
        <div class="p-4 border-t border-slate-800/50">
            <div class="flex items-center gap-2 text-xs text-slate-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span th:title="${gitBranch} + ' @ ' + ${gitCommitId}"
                      th:text="'Ledger ' + ${appVersion}">Ledger dev</span>
            </div>
        </div>
    </aside>

    <!-- ==================== Desktop Sidebar ==================== -->
    <aside id="desktop-sidebar"
           class="sidebar-transition hidden lg:flex fixed inset-y-0 left-0 z-40 flex-col
                  bg-slate-900 dark:bg-slate-950 sidebar-expanded"
           style="width: var(--sidebar-width);"
           data-collapsed="false">

        <!-- Desktop Logo -->
        <div class="flex items-center h-16 px-4 border-b border-slate-800/50 overflow-hidden">
            <div class="flex items-center gap-3">
                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-indigo-500 to-violet-600
                            rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/25">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div class="nav-label nav-label-transition whitespace-nowrap">
                    <h1 class="text-lg font-bold text-white tracking-tight">Ledger</h1>
                    <p class="text-xs text-slate-400">LLM Analytics</p>
                </div>
            </div>
        </div>

        <!-- Desktop Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 px-3">
            <div class="nav-label nav-label-transition mb-2 px-3">
                <span class="text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Dashboard</span>
            </div>

            <a th:href="@{/dashboard}"
               th:classappend="${currentPage == 'overview'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="flex-shrink-0 w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span class="nav-label nav-label-transition font-medium whitespace-nowrap">Overview</span>
                <!-- Tooltip for collapsed state -->
                <span class="nav-tooltip absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded-md whitespace-nowrap z-50">
                    Overview
                </span>
            </a>

            <a th:href="@{/dashboard/users}"
               th:classappend="${currentPage == 'users'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="flex-shrink-0 w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="nav-label nav-label-transition font-medium whitespace-nowrap">Users</span>
                <span class="nav-tooltip absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded-md whitespace-nowrap z-50">
                    Users
                </span>
            </a>

            <a th:href="@{/dashboard/models}"
               th:classappend="${currentPage == 'models'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="flex-shrink-0 w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="nav-label nav-label-transition font-medium whitespace-nowrap">Models</span>
                <span class="nav-tooltip absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded-md whitespace-nowrap z-50">
                    Models
                </span>
            </a>

            <a th:href="@{/dashboard/errors}"
               th:classappend="${currentPage == 'errors'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="flex-shrink-0 w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span class="nav-label nav-label-transition font-medium whitespace-nowrap">Errors</span>
                <span class="nav-tooltip absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded-md whitespace-nowrap z-50">
                    Errors
                </span>
            </a>

            <div class="nav-label nav-label-transition mt-6 mb-2 px-3">
                <span class="text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Management</span>
            </div>

            <a th:href="@{/dashboard/quota}"
               th:classappend="${currentPage == 'quota'} ? 'bg-gradient-to-r from-indigo-600/20 to-violet-600/10 text-white border-l-2 border-indigo-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'"
               class="nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 group">
                <svg class="flex-shrink-0 w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <span class="nav-label nav-label-transition font-medium whitespace-nowrap">Quota</span>
                <span class="nav-tooltip absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded-md whitespace-nowrap z-50">
                    Quota
                </span>
            </a>
        </nav>

        <!-- Desktop Footer with Version & Collapse Toggle -->
        <div class="p-3 border-t border-slate-800/50 space-y-2">
            <!-- Version Info -->
            <div class="flex items-center justify-center gap-2 px-3 py-2 text-slate-500 hover:text-slate-400 transition-colors cursor-default"
                 th:title="${gitBranch} + ' @ ' + ${gitCommitId}">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                <span class="nav-label nav-label-transition text-xs whitespace-nowrap"
                      th:text="${appVersion}">dev</span>
            </div>
            <!-- Collapse Toggle -->
            <button id="sidebar-toggle"
                    onclick="SidebarManager.toggle()"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2.5
                           text-slate-400 hover:text-white hover:bg-slate-800/50
                           rounded-lg transition-all duration-200">
                <svg class="toggle-icon toggle-icon-transition w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                </svg>
                <span class="nav-label nav-label-transition text-sm whitespace-nowrap">Collapse</span>
            </button>
        </div>
    </aside>

    <!-- ==================== Main Content ==================== -->
    <main id="main-content"
          class="main-transition min-h-screen lg:ml-[256px]">

        <!-- Top Header Bar -->
        <header class="glass-card sticky top-0 z-30 border-b border-slate-200/50 dark:border-slate-700/50">
            <div class="px-4 sm:px-6 lg:px-8 py-3 sm:py-4 flex justify-between items-center">
                <!-- Mobile Menu Button -->
                <button onclick="openMobileSidebar()"
                        class="lg:hidden p-2 -ml-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-6 h-6 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>

                <!-- Page Title -->
                <h2 class="text-lg sm:text-xl font-semibold text-slate-800 dark:text-white truncate"
                    th:text="${pageTitle}">Dashboard</h2>

                <!-- Right Side Actions -->
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- Time Display -->
                    <span id="header-local-time"
                          class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 hidden sm:inline"></span>

                    <!-- Theme Toggle -->
                    <button onclick="ThemeManager.toggle()"
                            class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800
                                   hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                            title="Toggle theme">
                        <!-- Sun icon (visible in dark mode) -->
                        <svg class="w-5 h-5 text-amber-500 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                        </svg>
                        <!-- Moon icon (visible in light mode) -->
                        <svg class="w-5 h-5 text-slate-600 dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="p-4 sm:p-6 lg:p-8">
            <div th:replace="${content}"></div>
        </div>
    </main>

    <!-- ==================== Scripts ==================== -->
    <script>
        // === Sidebar Manager ===
        const SidebarManager = {
            STORAGE_KEY: 'ledger-sidebar-collapsed',

            init() {
                const isCollapsed = localStorage.getItem(this.STORAGE_KEY) === 'true';
                if (isCollapsed) {
                    this.collapse(false);
                }
            },

            toggle() {
                const sidebar = document.getElementById('desktop-sidebar');
                const isCollapsed = sidebar.dataset.collapsed === 'true';

                if (isCollapsed) {
                    this.expand();
                } else {
                    this.collapse();
                }
            },

            collapse(save = true) {
                const sidebar = document.getElementById('desktop-sidebar');
                const main = document.getElementById('main-content');

                sidebar.dataset.collapsed = 'true';
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                sidebar.style.width = 'var(--sidebar-collapsed-width)';

                main.style.marginLeft = 'var(--sidebar-collapsed-width)';

                if (save) {
                    localStorage.setItem(this.STORAGE_KEY, 'true');
                }
            },

            expand() {
                const sidebar = document.getElementById('desktop-sidebar');
                const main = document.getElementById('main-content');

                sidebar.dataset.collapsed = 'false';
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                sidebar.style.width = 'var(--sidebar-width)';

                main.style.marginLeft = 'var(--sidebar-width)';

                localStorage.setItem(this.STORAGE_KEY, 'false');
            }
        };

        // === Theme Manager ===
        const ThemeManager = {
            STORAGE_KEY: 'ledger-theme',

            toggle() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem(this.STORAGE_KEY, isDark ? 'dark' : 'light');
                this.updateChartColors();
            },

            updateChartColors() {
                // Update Chart.js defaults when theme changes
                if (typeof Chart !== 'undefined') {
                    const isDark = document.documentElement.classList.contains('dark');
                    Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
                    Chart.defaults.borderColor = isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(0, 0, 0, 0.05)';

                    // Trigger redraw of existing charts
                    Chart.instances.forEach(chart => chart.update());
                }
            }
        };

        // === Mobile Sidebar Functions ===
        function openMobileSidebar() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');

            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-100', 'pointer-events-auto');
            document.body.classList.add('overflow-hidden');
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');

            sidebar.classList.add('-translate-x-full');
            overlay.classList.remove('opacity-100', 'pointer-events-auto');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('overflow-hidden');
        }

        // === Timezone Utilities ===
        const TimezoneUtils = {
            formatLocalTime: (utcString, format = 'YYYY-MM-DD HH:mm') => {
                if (!utcString) return '-';
                return dayjs(utcString).format(format);
            },
            initLocalTimeElements: () => {
                document.querySelectorAll('[data-utc]').forEach(el => {
                    const utc = el.dataset.utc;
                    const fmt = el.dataset.format || 'YYYY-MM-DD HH:mm';
                    el.textContent = TimezoneUtils.formatLocalTime(utc, fmt);
                });
            }
        };

        // === Initialize on DOM Ready ===
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sidebar state
            SidebarManager.init();

            // Initialize time display
            TimezoneUtils.initLocalTimeElements();
            const headerTime = document.getElementById('header-local-time');
            if (headerTime) {
                headerTime.textContent = dayjs().format('YYYY-MM-DD HH:mm');
            }

            // Close mobile sidebar on navigation
            document.querySelectorAll('#mobile-sidebar a').forEach(link => {
                link.addEventListener('click', closeMobileSidebar);
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    closeMobileSidebar();
                }
            });

            // Keyboard shortcut: Ctrl/Cmd + B to toggle sidebar
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    if (window.innerWidth >= 1024) {
                        SidebarManager.toggle();
                    }
                }
            });
        });
    </script>
</body>
</html>
