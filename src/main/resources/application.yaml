# =============================================================================
# Ledger - LLM 用量帳本服務 - 基礎共用配置
# =============================================================================
# 此檔案包進 Docker Image,包含所有環境共用的配置
# 環境特定配置透過 config/ 目錄下的 profile 檔案覆蓋
#
# 配置設計哲學:
#   - 雙層 Profile 架構: 基礎設施層 (local/gcp) + 行為層 (dev/lab/prod)
#   - AOT 友好: 所有屬性提供預設值,使用 ${property:default} 語法
#   - 結構與值分離: YAML 定義結構,值由環境提供
# =============================================================================

spring:
  application:
    name: ledger
  profiles:
    # 預設 profiles (本地開發)
    # 雙層架構: local (基礎設施) + dev (行為)
    default: local,dev
  # 啟用 Virtual Threads (Java 21+)
  # 對事件消費和聚合計算有顯著效能提升
  threads:
    virtual:
      enabled: true
  # 啟用 @Observed 註解支援 (預先配置,確保專案一致性)
  observations:
    annotations:
      enabled: true
  # 優雅關閉配置
  lifecycle:
    timeout-per-shutdown-phase: 30s
  cloud:
    # 禁用 RefreshScope - Spring Cloud RefreshScope 不支援 AOT/Native Image
    # 參考: https://github.com/spring-cloud/spring-cloud-release/wiki/AOT-transformations-and-native-image-support
    refresh:
      enabled: false
    # Spring Cloud Stream 配置
    # Function Bean 名稱: usageEventConsumer
    # 自動綁定名稱: usageEventConsumer-in-0
    function:
      definition: usageEventConsumer
    stream:
      bindings:
        usageEventConsumer-in-0:
          destination: llm-gateway-usage
          group: ledger
          content-type: application/cloudevents+json

# 應用程式配置
ledger:
  batch:
    size: 500                        # 累積 500 筆後批量寫入
    flush-cron: "0 0,30 * * * *"      # 每小時 00 分和 30 分刷新
    settlement-cron: "0 0 * * * *"    # 每小時整點結算
  pricing:
    # Claude Sonnet 4
    claude-sonnet-4-20250514:
      input-per-million: 3.00
      output-per-million: 15.00
      cache-read-per-million: 0.30
      cache-write-per-million: 3.75
    # Claude Opus 4
    claude-opus-4-20250514:
      input-per-million: 15.00
      output-per-million: 75.00
      cache-read-per-million: 1.50
      cache-write-per-million: 18.75
    # Claude Haiku 3.5
    claude-haiku-3-5-20241022:
      input-per-million: 0.80
      output-per-million: 4.00
      cache-read-per-million: 0.08
      cache-write-per-million: 1.00
  # 延遲百分位計算設定
  latency:
    digest-compression: 100   # T-Digest 壓縮因子 (50-200)，值越高精度越高但記憶體使用越多
  # 預設配額設定
  quota:
    default-token-limit: 0           # 預設 Token 限制，0 表示無限制
    default-cost-limit-usd: 0        # 預設成本限制 (USD)，0 表示無限制
    default-period: MONTHLY          # 配額週期：DAILY, WEEKLY, MONTHLY

# 優雅關閉
server:
  shutdown: graceful
  port: 8080

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,scheduledtasks
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  # OpenTelemetry 配置 (Spring Boot 3.x)
  # 取樣率由環境 profile 控制 (lab=1.0, prod=0.1)
  # 本地開發: Docker Compose 自動偵測 grafana-lgtm 容器並配置 OTLP 端點
  # 部署環境: 設定業界標準環境變數 OTEL_EXPORTER_OTLP_ENDPOINT
  tracing:
    sampling:
      probability: 1.0

logging:
  level:
    root: INFO
    io.github.samzhu.ledger: DEBUG
